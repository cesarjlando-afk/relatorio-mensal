<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relat√≥rio Mensal</title>
<link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon-192.png" type="image/png">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f5f5f5;
  }

  header {
    background: #004aad;
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    border-radius: 0 0 10px 10px;
  }

  header strong {
    display: block;
    font-size: 18px;
    margin-bottom: 5px;
  }

  .container {
    max-width: 900px;
    margin: auto;
    padding: 15px;
  }

  h1 {
    text-align: center;
    font-size: 18px;
    margin-top: 10px;
  }

  .categoria {
    background: white;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 5px rgba(0,0,0,0.1);
  }

  .botoes {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 5px;
    justify-content: center;
  }

  button {
    background: #004aad;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
  }

  button:hover { background: #003a82; }

  .camera-container {
    display: none;
    text-align: center;
    margin-top: 5px;
  }

  .camera-container video {
    width: 250px;
    height: 180px;
    border-radius: 10px;
    margin-bottom: 5px;
  }

  .camera-container .capture-btn {
    margin-top: 5px;
  }

  .fotos {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    justify-content: center;
  }

  .foto-item {
    width: 32%;
    text-align: center;
  }

  .foto-item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
  }

  .descricao {
    width: 100%;
    margin-top: 5px;
  }

  textarea {
    width: 100%;
    resize: none;
    height: 50px;
  }

  .topo {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
  }

  .login {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 100px;
  }

  .login input {
    margin: 5px;
    padding: 10px;
    width: 250px;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  .sair-final {
    text-align: center;
    margin-top: 20px;
  }

  .sair-final button {
    background: #dc3545;
  }

  .sair-final button:hover {
    background: #b02a37;
  }

</style>
</head>
<body>

<header>
  <strong>Birmann 29 (Antonio Alves F. Guedes) - B29</strong>
  Brig. Faria Lima, 3729 - Itaim Bibi, S√£o Paulo - SP
</header>

<div id="loginPage" class="login">
  <h2>Login</h2>
  <input id="usuario" placeholder="Usu√°rio">
  <input id="senha" placeholder="Senha" type="password">
  <button onclick="login()">Entrar</button>
</div>

<div id="app" style="display:none;">
  <div class="topo">
    <button onclick="iniciarRelatorio()">üìù Iniciar Relat√≥rio</button>
    <h1>Relat√≥rio Mensal</h1>
    <button onclick="gerarPDF()">üìÑ Gerar PDF</button>
  </div>
  <div class="container" id="categorias"></div>

  <div class="sair-final">
    <button onclick="sair()">üö™ Sair</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('Service Worker registrado com sucesso:', reg))
      .catch(err => console.error('Falha ao registrar Service Worker:', err));
  }
  
const categorias = [
  "Acompanhamentos Preventivos",
  "Vistorias T√©cnicas",
  "Check-list",
  "Pend√™ncias",
  "Atendimento Primeiros Socorros",
  "Informa√ß√µes"
];

let usuarioAtual = "";
let streamAtual = null;
let categoriaAtiva = null;


function login() {
  const user = document.getElementById("usuario").value.trim();
  const pass = document.getElementById("senha").value.trim();

  if ((user === "Cesar Lando" && pass === "25242") ||
      (user === "Bravos Birmann29" && pass === "BravosB29")) {
    
    usuarioAtual = user;
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    carregarCategorias();
  } else {
    alert("Usu√°rio ou senha incorretos!");
  }
}

function carregarCategorias() {
  const container = document.getElementById("categorias");
  container.innerHTML = "";
  categorias.forEach(nome => {
    const div = document.createElement("div");
    div.className = "categoria";

    // Se for "Informa√ß√µes", apenas textarea
    if (nome === "Informa√ß√µes") {
      div.innerHTML = `
        <h3 style="text-align:center;">${nome}</h3>
        <div class="descricao">
          <textarea id="desc_${nome}" placeholder="Descreva as informa√ß√µes..."></textarea>
          <button onclick="salvarDescricao('${nome}')">üíæ Salvar</button>
        </div>
      `;
    } else {
      div.innerHTML = `
        <h3 style="text-align:center;">${nome}</h3>
        <div class="botoes">
          <button onclick="abrirCamera('${nome}')">üì∑ Abrir C√¢mera</button>
          <button onclick="abrirGaleria('${nome}')">üñºÔ∏è Abrir Galeria</button>
        </div>
        <div class="camera-container" id="camera_${nome}">
          <video autoplay playsinline></video>
          <button class="capture-btn" onclick="capturarFoto('${nome}')">üì∏ Capturar Imagem</button>
        </div>
        <div class="descricao">
          <textarea id="desc_${nome}" placeholder="Descri√ß√£o..."></textarea>
          <button onclick="salvarDescricao('${nome}')">üíæ Salvar</button>
        </div>
        <div class="fotos" id="fotos_${nome}"></div>
      `;
    }
    container.appendChild(div);
  });
  restaurarFotos();
}


function abrirCamera(cat) {
  categoriaAtiva = cat;
  const container = document.getElementById(`camera_${cat}`);
  const video = container.querySelector("video");

  navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: "environment" } } })
    .then(stream => {
      streamAtual = stream;              // guarda o stream globalmente
      video.srcObject = stream;          // aplica o stream no v√≠deo correto
      video.play();                      // garante que o v√≠deo comece a tocar
      container.style.display = "block";
      container.scrollIntoView({ behavior: "smooth" });
    })
    .catch(err => {
      alert("Erro ao acessar a c√¢mera: " + err);
    });
}


function capturarFoto(cat) {
  if (!streamAtual) { 
    alert("Abra a c√¢mera primeiro!"); 
    return; 
  }

  const container = document.getElementById(`camera_${cat}`);
  const video = container.querySelector("video");

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth || 640;
  canvas.height = video.videoHeight || 480;
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);

  // Gera a imagem comprimida
  const dataUrl = canvas.toDataURL('image/jpeg', 0.5);

  // Data/hora autom√°tica (registro original)
  const agora = new Date();
  const hora = agora.toLocaleString(); // o que voc√™ j√° usava

  // Valor padr√£o para <input type="datetime-local">
  // Formato: "YYYY-MM-DDTHH:MM"
  const ano = agora.getFullYear();
  const mes = String(agora.getMonth() + 1).padStart(2, "0");
  const dia = String(agora.getDate()).padStart(2, "0");
  const horas = String(agora.getHours()).padStart(2, "0");
  const minutos = String(agora.getMinutes()).padStart(2, "0");
  const dataHoraCustom = `${ano}-${mes}-${dia}T${horas}:${minutos}`;

  const fotoObj = { 
    img: dataUrl, 
    desc: "", 
    hora,            // registro ‚Äúfixo‚Äù (quando a foto foi tirada)
    dataHoraCustom   // campo que o usu√°rio poder√° editar
  };

  const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");
  fotos.push(fotoObj);

  try {
    localStorage.setItem(`fotos_${cat}`, JSON.stringify(fotos));
    renderizarFotos(cat);
  } catch (e) {
    alert('Espa√ßo insuficiente no navegador! Apague algumas fotos ou use imagens menores.');
  }

  // Fecha a c√¢mera
  container.style.display = "none";
  streamAtual.getTracks().forEach(track => track.stop());
  streamAtual = null;
}


function abrirGaleria(cat) {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.multiple = false; // uma por vez

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
      const img = new Image();
      img.onload = () => {
        // Redimensiona a imagem (como voc√™ j√° fazia)
        const maxW = 800;
        const maxH = 600;
        let width = img.width;
        let height = img.height;

        if (width > maxW) {
          height = Math.round(height * (maxW / width));
          width = maxW;
        }
        if (height > maxH) {
          width = Math.round(width * (maxH / height));
          height = maxH;
        }

        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        canvas.getContext('2d').drawImage(img, 0, 0, width, height);

        // Gera a imagem comprimida
        const dataUrl = canvas.toDataURL('image/jpeg', 0.55);

        // Data/hora autom√°tica (momento em que a imagem foi adicionada ao relat√≥rio)
        const agora = new Date();
        const hora = agora.toLocaleString();

        // Valor padr√£o para <input type="datetime-local">
        const ano = agora.getFullYear();
        const mes = String(agora.getMonth() + 1).padStart(2, "0");
        const dia = String(agora.getDate()).padStart(2, "0");
        const horas = String(agora.getHours()).padStart(2, "0");
        const minutos = String(agora.getMinutes()).padStart(2, "0");
        const dataHoraCustom = `${ano}-${mes}-${dia}T${horas}:${minutos}`;

        const fotoObj = { 
          img: dataUrl, 
          desc: "", 
          hora,            // registro ‚Äúfixo‚Äù
          dataHoraCustom   // campo edit√°vel
        };

        const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");
        fotos.push(fotoObj);

        try {
          localStorage.setItem(`fotos_${cat}`, JSON.stringify(fotos));
          renderizarFotos(cat);
        } catch(e) {
          alert("Espa√ßo insuficiente no navegador! Apague algumas fotos ou use imagens menores.");
        }
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };

  input.click();
}

function salvarDescricao(cat) {
  const desc = document.getElementById(`desc_${cat}`).value.trim();
  if (!desc) return alert("‚ö†Ô∏è Adicione uma descri√ß√£o antes de salvar!");
  const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");
  if (fotos.length === 0) return alert("‚ö†Ô∏è Nenhuma foto capturada!");
  fotos[fotos.length - 1].desc = desc;
  localStorage.setItem(`fotos_${cat}`, JSON.stringify(fotos));
  document.getElementById(`desc_${cat}`).value = "";
  renderizarFotos(cat);
}

function renderizarFotos(cat) {
  const fotosDiv = document.getElementById(`fotos_${cat}`);
  if (!fotosDiv) return;

  fotosDiv.innerHTML = "";
  const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");

  fotos.forEach((f, idx) => {
    const div = document.createElement("div");
    div.className = "foto-item";

    // garante um valor v√°lido para o input datetime-local
    let valorDataHora = f.dataHoraCustom;
    if (!valorDataHora) {
      const agora = new Date();
      const ano = agora.getFullYear();
      const mes = String(agora.getMonth() + 1).padStart(2, "0");
      const dia = String(agora.getDate()).padStart(2, "0");
      const horas = String(agora.getHours()).padStart(2, "0");
      const minutos = String(agora.getMinutes()).padStart(2, "0");
      valorDataHora = `${ano}-${mes}-${dia}T${horas}:${minutos}`;
    }

    div.innerHTML = `
      <img src="${f.img}">
      <p>Registrado: ${f.hora || ""}</p>

      <label style="font-size: 11px; display:block; margin-top:2px;">
        Data/Hora da imagem:
      </label>
      <input 
        type="datetime-local"
        value="${valorDataHora}"
        onchange="atualizarDataHora('${cat}', ${idx}, this.value)"
        style="width: 100%; font-size: 11px; margin-bottom: 4px;"
      >

      <textarea 
        placeholder="Descri√ß√£o..." 
        onblur="atualizarDescricao('${cat}', ${idx}, this.value)"
      >${f.desc || ""}</textarea>
    `;

    fotosDiv.appendChild(div);
  });
}

function restaurarFotos() {
  categorias.forEach(cat => renderizarFotos(cat));
}

function iniciarRelatorio() {
  if (confirm("Iniciar novo relat√≥rio? Isso apagar√° os dados anteriores.")) {
    categorias.forEach(cat => localStorage.removeItem(`fotos_${cat}`));
    localStorage.setItem("inicioRelatorio", new Date().toLocaleString()); // aqui!
    carregarCategorias();
    alert("‚úÖ Novo relat√≥rio iniciado!");
  }
}


function sair() {
  document.getElementById("app").style.display = "none";
  document.getElementById("loginPage").style.display = "flex";
}

function gerarPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");

  // CABE√áALHO
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.text("Relat√≥rio Mensal", doc.internal.pageSize.getWidth() / 2, 10, { align: "center" });

  doc.setFontSize(10);
  doc.text("Birmann 29 (Antonio Alves F. Guedes) - B29", doc.internal.pageSize.getWidth() / 2, 16, { align: "center" });
  doc.text("Brig. Faria Lima, 3729 - Itaim Bibi, S√£o Paulo - SP", doc.internal.pageSize.getWidth() / 2, 21, { align: "center" });
  doc.text(`Respons√°vel: ${usuarioAtual}`, doc.internal.pageSize.getWidth() / 2, 27, { align: "center" });

  doc.setFont("helvetica", "normal");
  let y = 35;

  // ITENS + FOTOS
  categorias.forEach(cat => {
    if (cat === "Informa√ß√µes") return;

    const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");

    if (fotos.length > 0) {
      doc.setFont("helvetica", "bold");
      doc.setFontSize(12);
      doc.text(cat, doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
      doc.setFont("helvetica", "normal");

      y += 6;
      let linhaAltura = 0;

      fotos.forEach((f, i) => {
        if (i % 4 === 0 && y > 240) {
          doc.addPage();
          y = 20;
        }

        const x = 10 + (i % 4) * 45;
        const fotoY = y;

        const mostrarImagem =
          cat !== "Atendimento Primeiros Socorros" ||
          (cat === "Atendimento Primeiros Socorros" && f.img);

        if (mostrarImagem && f.img) {
          doc.addImage(f.img, "JPEG", x, fotoY, 35, 28);

          doc.setFontSize(8);
          let textoData = f.hora || "";
          if (f.dataHoraCustom) {
            const d = new Date(f.dataHoraCustom + ":00");
            textoData = d.toLocaleString("pt-BR");
          }
          doc.text(textoData, x, fotoY + 31);
        }

        const splitDesc = doc.splitTextToSize(f.desc || "", 35);
        let descY = (mostrarImagem && f.img) ? fotoY + 36 : fotoY;

        splitDesc.forEach((line, idx) => {
          doc.text(line, x, descY + (idx * 4));
        });

        const alturaBloco =
          (mostrarImagem && f.img ? 36 : 0) +
          (splitDesc.length * 4);

        if (alturaBloco > linhaAltura) linhaAltura = alturaBloco;

        if ((i + 1) % 4 === 0) {
          y += Math.max(40, linhaAltura);
          linhaAltura = 0;
        }
      });

      if (fotos.length % 4 !== 0) {
        y += Math.max(40, linhaAltura);
      }
    }
  });

  // CONCLUS√ÉO / INFORMA√á√ïES (igual ao seu c√≥digo)
  const info = document.getElementById("desc_Informa√ß√µes")?.value.trim() || "";

  if (info) {
    if (y > 250) { doc.addPage(); y = 20; }

    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Conclus√£o / Informa√ß√µes:", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });

    doc.setFont("helvetica", "normal");
    y += 8;

    doc.setFontSize(10);
    const splitText = doc.splitTextToSize(info, 180);
    const pageWidth = doc.internal.pageSize.getWidth();

    splitText.forEach((line, index) => {
      doc.text(line, pageWidth / 2, y + index * 6, { align: "center" });
    });

    y += splitText.length * 6 + 6;
  }

  // RODAP√â (igual)
  if (y > 260) { doc.addPage(); y = 20; }

  const inicio = localStorage.getItem("inicioRelatorio") || "N√£o registrado";
  const termino = new Date().toLocaleString("pt-BR");

  doc.setFontSize(10);
  doc.text(`In√≠cio do relat√≥rio: ${inicio}`, 10, y);
  doc.text(`T√©rmino do relat√≥rio: ${termino}`, 10, y + 6);

  // SALVAR
  const nome = `Relatorio_${new Date().toLocaleDateString("pt-BR")}_${new Date().getTime()}.pdf`;
  doc.save(nome);

  alert("‚úÖ PDF gerado e salvo com sucesso!");

  categorias.forEach(cat => localStorage.removeItem(`fotos_${cat}`));
  localStorage.removeItem("inicioRelatorio");
  const infoEl = document.getElementById("desc_Informa√ß√µes");
  if (infoEl) infoEl.value = "";
  carregarCategorias();
}


function atualizarDescricao(cat, idx, desc) {
  const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");
  fotos[idx].desc = desc.trim();
  localStorage.setItem(`fotos_${cat}`, JSON.stringify(fotos));
}

function atualizarDataHora(cat, idx, valor) {
  const fotos = JSON.parse(localStorage.getItem(`fotos_${cat}`) || "[]");
  fotos[idx].dataHoraCustom = valor;
  localStorage.setItem(`fotos_${cat}`, JSON.stringify(fotos));
}
</script>
</body>
</html>
